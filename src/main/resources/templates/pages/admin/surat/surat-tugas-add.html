<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  layout:decorate="~{layouts/app}"
>
  <head
    th:replace="~{fragments/header :: header('Generate Surat Tugas')}"
  ></head>
  <body>
    <div layout:fragment="content">
      <div class="container-fluid">
        <form
          th:action="@{/admin/surat-tugas-asesor/generate}"
          method="post"
          th:object="${suratDto}"
          target="_blank"
          id="formGenerate"
        >
          <div class="card card-blue-dark">
            <div class="card-header">
              <h3 class="card-title">Form Generate Surat Tugas</h3>
            </div>
            <div class="card-body">
              <div class="row bg-light p-3 mb-4 rounded">
                <div class="col-md-6">
                  <div class="form-group mb-0">
                    <label>Nomor Surat</label>
                    <input
                      type="text"
                      class="form-control"
                      th:field="*{nomorSurat}"
                      readonly
                      style="background-color: white"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group mb-0">
                    <label>Tanggal Surat</label>
                    <input
                      type="date"
                      class="form-control"
                      th:field="*{tanggalSurat}"
                      readonly
                      style="background-color: white"
                    />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label
                  >1. Pilih Jadwal Kegiatan
                  <span class="text-danger">*</span></label
                >
                <select
                  class="form-control select2"
                  th:field="*{jadwalId}"
                  id="selectJadwal"
                  required
                  style="width: 100%"
                >
                  <option value="" selected>
                    -- Cari Kode / Nama Jadwal --
                  </option>
                  <option
                    th:each="j : ${listJadwal}"
                    th:value="${j.id}"
                    th:text="${j.code + ' - ' + j.name}"
                  ></option>
                </select>
                <small class="text-muted"
                  >Pilih jadwal untuk memuat data TUK, Skema, dan Asesor yang
                  bertugas.</small
                >
              </div>

              <hr />

              <div id="wrapperDetail">
                <h5 class="text-primary mb-3">
                  2. Pilih Asesor & Detail Penugasan
                </h5>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label
                        >Pilih Asesor <span class="text-danger">*</span></label
                      >
                      <select
                        class="form-control select2"
                        th:field="*{asesorId}"
                        id="selectAsesor"
                        required
                        style="width: 100%"
                      >
                        <option value="">-- Menunggu Pilihan Jadwal --</option>
                      </select>
                      <small class="text-info d-none" id="infoAsesorEmpty">
                        <i class="fas fa-info-circle"></i> Data asesor kosong
                        atau sudah dibuatkan semua.
                      </small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>No. Registrasi (MET)</label>
                      <input
                        type="text"
                        class="form-control"
                        id="displayNoMet"
                        readonly
                      />
                    </div>
                  </div>
                </div>

                <div class="row mt-2">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>Skema Sertifikasi</label>
                      <input
                        type="text"
                        class="form-control"
                        id="displaySkema"
                        readonly
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>Tempat Uji Kompetensi (TUK)</label>
                      <input
                        type="text"
                        class="form-control"
                        id="displayTuk"
                        readonly
                      />
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <label>Tanggal Pelaksanaan</label>
                      <input
                        type="text"
                        class="form-control"
                        id="displayTanggal"
                        readonly
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <button
                type="submit"
                class="btn btn-warning btn-block"
                id="btnGenerate"
              >
                <i class="fas fa-print mr-2"></i> Generate & Simpan Surat Tugas
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <th:block layout:fragment="script">
      <script>
        $(document).ready(function () {
          // Init Select2
          $(".select2").select2({ theme: "bootstrap4" });

          // =========================================================
          // LOGIKA: SAAT JADWAL DIPILIH -> ISI DATA LAIN
          // =========================================================
          $("#selectJadwal").on("change", function () {
            var jadwalId = $(this).val();

            // 1. Reset Form Bawah (Kosongkan dulu biar bersih)
            $("#selectAsesor")
              .empty()
              .append('<option value="">-- Memuat Data... --</option>');
            $("#displayNoMet").val("");
            $("#displaySkema").val("");
            $("#displayTuk").val("");
            $("#displayTanggal").val("");
            $("#infoAsesorEmpty").addClass("d-none");

            if (jadwalId) {
              // Loading indikator
              Swal.fire({
                title: "Memuat Data...",
                text: "Mengambil detail jadwal...",
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading(),
              });

              // 2. Fetch Data via AJAX
              // Pastikan URL ini benar sesuai Controller (/admin/api/...)
              $.ajax({
                url: "/admin/api/internal/schedule/" + jadwalId + "/details",
                type: "GET",
                dataType: "json",
                success: function (response) {
                  Swal.close();

                  // A. Isi Field Readonly (Skema, TUK, Tanggal)
                  $("#displaySkema").val(response.skemaName);
                  $("#displayTuk").val(response.tukName);
                  $("#displayTanggal").val(response.tanggalPelaksanaan);

                  // B. Isi Dropdown Asesor
                  var asesorOpts =
                    '<option value="" selected>-- Pilih Asesor --</option>';
                  var assessors = response.assessors;

                  if (assessors && assessors.length > 0) {
                    assessors.forEach(function (a) {
                      // Simpan NoMet di attribut data-nomet agar mudah diambil
                      asesorOpts += `<option value="${a.id}" data-nomet="${a.noMet}">${a.fullName}</option>`;
                    });
                  } else {
                    asesorOpts =
                      '<option value="">Tidak ada asesor tersedia</option>';
                    $("#infoAsesorEmpty").removeClass("d-none");
                  }

                  $("#selectAsesor").html(asesorOpts);
                },
                error: function (xhr) {
                  Swal.close();
                  console.error(xhr);
                  Swal.fire(
                    "Gagal",
                    "Terjadi kesalahan saat mengambil data jadwal.",
                    "error"
                  );
                  $("#selectAsesor").html(
                    '<option value="">Gagal Memuat</option>'
                  );
                },
              });
            } else {
              // Jika user reset pilihan jadwal ke default
              $("#selectAsesor").html(
                '<option value="">-- Pilih Jadwal Terlebih Dahulu --</option>'
              );
            }
          });

          // =========================================================
          // LOGIKA: SAAT ASESOR DIPILIH -> ISI NO MET
          // =========================================================
          $("#selectAsesor").on("change", function () {
            // Ambil data-nomet dari option yang dipilih
            var noMet = $(this).find(":selected").data("nomet");

            if (noMet) {
              $("#displayNoMet").val(noMet);
            } else {
              $("#displayNoMet").val("");
            }
          });

          // =========================================================
          // LOGIKA: REFRESH SETELAH GENERATE
          // =========================================================
          $("#formGenerate").on("submit", function () {
            // Beri waktu 2 detik agar PDF terdownload, lalu refresh halaman
            setTimeout(function () {
              Swal.fire({
                title: "Berhasil!",
                text: "Surat tugas sedang didownload. Halaman akan dimuat ulang.",
                icon: "success",
                timer: 2000,
                showConfirmButton: false,
              }).then(() => {
                window.location.reload();
              });
            }, 1000);
          });
        });
      </script>
    </th:block>
  </body>
</html>
