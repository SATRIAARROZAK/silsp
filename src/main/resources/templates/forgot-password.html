<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SILSP | Lupa Kata Sandi</title>
    <link
      rel="stylesheet"
      th:href="@{/plugins/fontawesome-free/css/all.min.css}"
    />
    <link rel="stylesheet" th:href="@{/dist/css/login.css}" />
    <link
      rel="stylesheet"
      th:href="@{/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css}"
    />
    <style>
      /* Override untuk halaman forgot */
      .col-left {
        background: linear-gradient(135deg, #1f71c3 0%, #0d47a1 100%);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-left">
          <div class="banner">
            <img
              th:src="@{/dist/img/LogoLSP.png}"
              alt="Logo LSP"
              style="width: 60%"
            />
            <h3 class="mt-3 text-white">Reset Kata Sandi</h3>
          </div>
        </div>
        <div class="col-right">
          <div class="card-header text-center">
            <h1>Lupa Kata Sandi?</h1>
            <p>Masukkan email Anda untuk menerima tautan reset.</p>
          </div>

          <div
            th:if="${error}"
            class="alert alert-danger text-center p-2 mb-3"
            style="width: 100%; border-radius: 5px"
          >
            <small th:text="${error}"></small>
          </div>

          <form id="forgotForm" th:action="@{/forgot-password}" method="post">
            <div class="form-group">
              <label>Email Terdaftar <span class="text-danger">*</span></label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"
                    ><i class="fas fa-envelope"></i
                  ></span>
                </div>
                <input
                  type="email"
                  class="input form-control"
                  name="email"
                  id="email"
                  placeholder="contoh@email.com"
                  required
                  autofocus
                />
              </div>
            </div>

            <div class="form-group mt-4">
              <button type="submit" class="btn-login">
                Kirim Tautan Reset
              </button>
            </div>

            <div class="register-link mt-3">
              <a th:href="@{/login}">Kembali ke Login</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script th:src="@{/plugins/jquery/jquery.min.js}"></script>
    <script th:src="@{/plugins/sweetalert2/sweetalert2.min.js}"></script>
    <script>
      $(document).ready(function () {
        $("#forgotForm").on("submit", function (e) {
          e.preventDefault();
          var email = $("#email").val();

          if (!email) return;

          // Ambil semua data form termasuk token CSRF (_csrf) yang hidden
          var formData = $(this).serialize();

          Swal.fire({
            title: "Mengirim Email...",
            text: "Mohon tunggu sebentar",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          // Gunakan formData di sini
          $.post($(this).attr("action"), formData, function (response) {
            var res =
              typeof response === "string" ? JSON.parse(response) : response;
            Swal.fire({
              icon: "success",
              title: "Terkirim!",
              text: res.message,
              confirmButtonText: "Oke",
            });
          }).fail(function (xhr) {
            // Handle error response dari controller
            var msg = "Terjadi kesalahan sistem";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              msg = xhr.responseJSON.message;
            }
            Swal.fire("Gagal", msg, "error");
          });
        });
      });
    </script>
  </body>
</html>
