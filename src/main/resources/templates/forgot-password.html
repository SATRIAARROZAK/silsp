<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SILSP | Lupa Kata Sandi</title>
    <link
      rel="stylesheet"
      th:href="@{/plugins/fontawesome-free/css/all.min.css}"
    />
    <link rel="stylesheet" th:href="@{/dist/css/login.css}" />
    <link
      rel="stylesheet"
      th:href="@{/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css}"
    />
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-left">
          <div class="banner">
            <img
              th:src="@{/dist/img/LogoLSP.png}"
              alt="Logo LSP"
              style="width: 60%"
            />
            <h3 class="mt-3 text-white">LSP Teknologi Data Digital Indonesia</h3>
          </div>
        </div>
        <div class="col-right">
          <div class="card-header text-center">
            <h1>Lupa Kata Sandi?</h1>
            <p>Masukkan email Anda untuk menerima tautan reset.</p>
          </div>

          <div
            th:if="${error}"
            class="alert alert-danger text-center p-2 mb-3"
            style="width: 100%; border-radius: 5px"
          >
            <small th:text="${error}"></small>
          </div>

          <form
            id="forgotForm"
            th:action="@{/forgot-password}"
            method="post"
            novalidate
          >
            <div class="form-group">
              <label>Email Terdaftar <span class="text-danger">*</span></label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"
                    ><i class="fas fa-envelope"></i
                  ></span>
                </div>
                <input
                  type="email"
                  class="input form-control"
                  name="email"
                  id="email"
                  placeholder="contoh@email.com"
                  required
                  autofocus
                />
              </div>
              <div class="invalid-feedback">Isi Email atau Username!</div>
            </div>

            <div class="form-group mt-4">
              <button type="submit" class="btn-login">
                Kirim Tautan Reset
              </button>
            </div>

            <div class="register-link mt-3">
              <a th:href="@{/login}">Kembali ke Login</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script th:src="@{/plugins/jquery/jquery.min.js}"></script>
    <script th:src="@{/plugins/sweetalert2/sweetalert2.min.js}"></script>
    <script>
      $(document).ready(function () {
        // Fungsi Validasi Error Visual
        function setError(inputElement, message) {
          // Tambahkan class error ke parent (input-group) agar border merah satu paket
          $(inputElement).closest(".input-group").addClass("is-invalid");

          // Ubah teks pesan error dan tampilkan
          var feedback = $(inputElement)
            .closest(".form-group")
            .find(".invalid-feedback");
          feedback.text(message);
          feedback.show();
        }

        function removeError(inputElement) {
          $(inputElement).closest(".input-group").removeClass("is-invalid");
          // Kembalikan pesan default (opsional) dan sembunyikan
          var feedback = $(inputElement)
            .closest(".form-group")
            .find(".invalid-feedback");
          feedback.hide();
        }
        // function showParamsError(element, message) {
        //   $(element).addClass("is-invalid");
        //   // Hapus pesan error lama jika ada
        //   $(element).closest(".form-group").find(".invalid-feedback").remove();
        //   // Tambahkan pesan error baru
        //   $(element).after(
        //     '<div class="invalid-feedback">' + message + "</div>"
        //   );
        // }

        // // Hapus error saat mengetik
        // $("input").on("input", function () {
        //   $(this).removeClass("is-invalid");
        //   $(this).next(".invalid-feedback").remove();
        // });

        $("#forgotForm").on("submit", function (e) {
          e.preventDefault();

          var emailInput = $("#email");
          var emailVal = emailInput.val().trim();

          // 1. VALIDASI FORM KOSONG
          if (!emailVal) {
            showParamsError(emailInput, "Harap isi email terlebih dahulu");
            emailInput.focus();
            return;
          }

          var formData = $(this).serialize();

          Swal.fire({
            title: "Sedang Memproses...",
            text: "Mohon tunggu sebentar",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          $.post($(this).attr("action"), formData, function (response) {
            var res =
              typeof response === "string" ? JSON.parse(response) : response;

            // 2. FITUR DIRECT KE LOGIN + TOAST
            // Simpan pesan sukses di LocalStorage agar bisa muncul di halaman Login
            localStorage.setItem("resetSuccessMessage", res.message);

            // Redirect ke halaman login
            window.location.href = "/login";
          }).fail(function (xhr) {
            var msg = "Terjadi kesalahan sistem";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              msg = xhr.responseJSON.message;
            }
            Swal.fire("Gagal", msg, "error");
          });
        });
      });
    </script>
  </body>
</html>
